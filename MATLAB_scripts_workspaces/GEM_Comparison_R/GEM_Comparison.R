#### Main Project #1: Analysis of metabolic models with a range of sys bio techniques ####

library(readxl)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(dplyr)
library(reshape2)
library(ggvenn)
library(gridExtra)
library(ggpubr)
library(ggallin)
library(stringr)
library(magrittr)
library(pheatmap)
require(grid)
library(tidyverse)


my.theme <- theme(axis.text = element_text(colour="black", size=15, face = "bold"),
                  text = element_text(size=16),
                  panel.background = element_rect(fill = 'gray99',
                                                  colour = "black",
                                                  linewidth=0.5),
                  axis.title.x=  element_text(vjust=-0.45, face = "bold"),
                  axis.title.y = element_text(vjust=1.2, face = "bold"),
                  axis.ticks = element_line(colour="black"),
                  axis.line = element_line(),
                  panel.grid.major = element_line(colour = "lightgray", linetype="dotted"),
                  panel.grid.minor = element_line(colour = "lightgray", linetype="dashed"),
                  legend.title=element_blank(),
                  legend.text = element_text(size = 14))

file.choose()

ControlRXN = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/OnlyReactionsFromModels/ControlModel.csv',
                      header = T)
# LPS

LPSRXN = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/OnlyReactionsFromModels/LPSModel.csv',
                  header = T)
# IL4

IL4RXN = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/OnlyReactionsFromModels/IL4Model.csv',
                  header = T)
reactions = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/reactions.csv')

#### Getting proper media compositions for model constraining ####
setwd("/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/GEM_Comparison_R")
options(scipen=999)
MediaCompDf = read.csv('MediaCompDf.csv', header = T, row.names = 1)

MediaCompDf = MediaCompDf %>%
  mutate(MetPercentage = (Concentration..mg.L. / sum(Concentration..mg.L.)) / 10 ) %>% #changing mg/L to g/L and then taking percentage in one step
  mutate(MetWeight = MetPercentage * 3) %>%
  mutate(FluxConstraint_mmol_per_mouse_day = (MetWeight / Molecular.Weight) * 1000)

write.csv(MediaCompDf, 'MediaCompDf.csv')


#Venn diagram of Constrained GEMs 
setwd("~/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models")


LPS = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/LPS_GEM_genes.csv',
               header = T)
IL4 = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/IL4_GEM_genes.csv',
               header = T)
Control = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/Control_GEM_genes.csv',
                   header = T)

x <- list(
  LPS = as.character(LPS$NAME), 
  IL4 = as.character(IL4$NAME), 
  Control = as.character(Control$NAME)
)

ggvenn(
  x, 
  fill_color = c("#0073C2FF", "#EFC000FF", "#CD534CFF"),
  stroke_size = 0.5, set_name_size = 4) + ggtitle("Genes in GEMs")


#### ReporterMetabolites analysis ####

par(mfrow=c(3,2))

generate_RepMets = function(RepMets, title) {
  
  RepMets = RepMets %>% 
    filter(metPValues < 0.05) %>%
    arrange(desc(metZScore)) %>%
    mutate(Compartment = case_when(
      endsWith(mets, "c") ~ "Cytosol",
      endsWith(mets, "p") ~ "Peroxisome",
      endsWith(mets, "m") ~ "Mitochondria",
      endsWith(mets, "s") ~ "Extracellular",
      endsWith(mets, "l") ~ "Lysosome",
      endsWith(mets, "r") ~ "Endoplasmic_reticulum",
      endsWith(mets, "g") ~ "Golgi_apparatus",
      endsWith(mets, "n") ~ "Nucleus",
      endsWith(mets, "i") ~ "Inner_mitochondria"
    )) %>%
    relocate(Compartment, .before = metZScore) %>%
    subset(!(metNames %in% c('H+','NADP+', 'NADPH', 'NAD+', 'NADH', 'H2O', 'Pi',
                             'O2', 'Na+', 'Fe3+', 'Fe2+', 'Cu2+', 'Ca2+'))) %>%
    select(-mets)
  
  RepMets$Compartment = as.factor(RepMets$Compartment)
  
  myColors <- colorRampPalette(brewer.pal(8, "Dark2"))(9)
  names(myColors) <- levels(RepMets$Compartment)
  custom_colors <- scale_colour_manual(name = "Compartment", values = myColors)
  
  g = ggplot(RepMets[1:20,], aes(x=reorder(metNames, metZScore), y=metZScore)) +
    geom_bar(aes(fill = Compartment), stat="identity") + coord_flip() + theme_light() +
    custom_colors +
    theme(axis.text = element_text(face="bold", size = 12),
          axis.title = element_text(face="bold", size = 14),
          legend.title = element_text(size = 14, face = "bold"),
          legend.text = element_text(size = 14),
          plot.title = element_text(size = 20)) +
    labs(x = NULL, title = title)
  return(g)
}

#file.choose()

setwd('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/Plots/RepMets/')
### IL4 ###

# general
IL4 = read.csv("/Users/rokosango/PhD/MetabModelling/RS/RS_IL4_full/RepMetsIL4.csv",
               header = T)

Compartment = str_sub(IL4$mets, -1, -1) # extract compartment letter
Mets = str_sub(IL4$mets, end=-2) # extract Metabolite name

IL4$ModelMetsNames = paste0(IL4$metNames,"[", Compartment, "]")

IL4 = IL4 %>%
  select(ModelMetsNames, metPValues) %>%
  rename(Name = ModelMetsNames) %>%
  rename("p-value" = metPValues)

write.xlsx2(IL4, "GSS_IL4.xlsx")

a = generate_RepMets(IL4, "Top 20 RepMets IL4")

a
# Up 
IL4 = read.csv("/Users/rokosango/PhD/MetabModelling/RS/RS_IL4_full/RepMetsIL4Up.csv",
               header = T)

b = generate_RepMets(IL4, "Top 20 RepMets IL4 Up")



# Down
IL4 = read.csv("/Users/rokosango/PhD/MetabModelling/RS/RS_IL4_full/RepMetsIL4Down.csv",
               header = T)
c = generate_RepMets(IL4, "Top 20 RepMets IL4 Down") 

c

### LPS ###

# general
LPS = read.csv("/Users/rokosango/PhD/MetabModelling/RS/RS_LPS_full/RepMetsLPS.csv",
               header = T)

Compartment = str_sub(LPS$mets, -1, -1) # extract compartment letter 
Mets = str_sub(LPS$mets, end=-2) # extract Metabolite name, I need both for Kiwi package

LPS$ModelMetsNames = paste0(LPS$metNames,"[", Compartment, "]")

LPS = LPS %>%
  select(ModelMetsNames, metPValues) %>%
  rename(Name = ModelMetsNames) %>%
  rename("p-value" = metPValues) # need quotation marks when there is a hyphen in the name

write.xlsx2(LPS, "GSS_LPS.xlsx")


d = generate_RepMets(LPS, "Top 20 RepMets LPS")



# Up
LPSUp = read.csv("/Users/rokosango/PhD/MetabModelling/RS/RS_LPS_full/RepMetsLPSUp.csv",
               header = T)
e = generate_RepMets(LPS, "Top 20 RepMets LPS Up")

e

# Down
LPS = read.csv("/Users/rokosango/PhD/MetabModelling/RS/RS_LPS_full/RepMetsLPSDown.csv",
               header = T)
f = generate_RepMets(LPS, "Top 20 RepMets LPS Down")

f

# combine plots

ggarrange(b, c, e, f,
             common.legend = T, legend = "bottom")

ggarrange(b,c, common.legend = T, legend = 'top')

ggarrange(e, f, common.legend = T, legend = 'top')


#### Exchange reactions ####
options(scipen = 1)

# Control
ControlRXN = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/OnlyReactionsFromModels/ControlModel.csv',
                   header = T)
# LPS
LPSRXN = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/OnlyReactionsFromSimplifiedModels/Simplified_LPS_rxns_only.csv',
                   header = T)
# IL4
IL4RXN = read.csv('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/OnlyReactionsFromSimplifiedModels/Simplified_IL4_rxns_only.csv',
               header = T)

FluxBarplots = function(x, title) {
  ggplot(x, aes(x=ReactionName, y=value, fill=variable)) +
    geom_bar(stat="identity", position = position_dodge(), alpha = 0.75) +theme_minimal() +
    theme(axis.text = element_text(face="bold", size = 12),
          axis.title = element_text(face="bold", size = 14)) +
    labs(x = NULL, y = "Fluxes", title = title)
  
}

#### Curated FBA ####

file.choose()

options(scipen = 999)

# curated fba: includes ExMet, Media Comp, manual curation to reduce amount of sink reactions,
# while keeping a functional objective (biomass).
# in percentages for each model, we have: 66% in LPS, 18% in IL4, 20% in Control GEM.
# another proof that IL4 and Control are similar, with LPS needing more sinks and always having higher biomass value,
# probably because they are needed to support aggregation of biomass precursors (proteins, dna, lipids, etc.) much 
# more than in [IL4, Control] scenarios

path = '/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/newFluxResults/'

LPSGapFilled = read_excel(paste0(path, "LPSFluxTable.xlsx"),
                          sheet = 1)
IL4GapFilled = read.xlsx2(paste0(path, "IL4FluxTable.xlsx"),
                          sheetIndex = 1)
CtrlGapFilled = read.xlsx2(paste0(path, "ControlFluxTable.xlsx"),
                          sheetIndex = 1)
Futile_Gapdh_KO = read_excel(paste0(path, "FluxTable_futile_gapdh.xlsx"),
                             sheet = 1)


prepFluxTables = function(FluxTable, allReactions, modelSpecificRxns) {
  
  # FluxTable = FluxTable %>%
  #   dplyr::select(ReactionID, Flux)
  
  
  FluxTable$ReactionName = allReactions$rxnRecon3DID[match(FluxTable$ReactionID, allReactions$rxns)]
  FluxTable$Flux = as.numeric(FluxTable$Flux)
  FluxTable$Subsystem = modelSpecificRxns$SUBSYSTEM[match(FluxTable$ReactionID, modelSpecificRxns$ID)]
  FluxTable$Subsystem = as.factor(FluxTable$Subsystem)
  FluxTable$Equation = modelSpecificRxns$EQUATION[match(FluxTable$ReactionID, modelSpecificRxns$ID)]
  
  return(FluxTable)
  
}

LPSGapFilled = prepFluxTables(LPSGapFilled, reactions, LPSRXN)
IL4GapFilled = prepFluxTables(IL4GapFilled, reactions, IL4RXN)
CtrlGapFilled = prepFluxTables(CtrlGapFilled, reactions, ControlRXN)


LPSGapFilled[6870, c("Subsystem", "Equation")] = c("Exchange/demand reactions", "NO[s] <=>")
LPSGapFilled[6869, c("Subsystem", "Equation")] = c("Transport reactions", "NO[c] <=> NO[s]")
LPSGapFilled[5153, "ReactionName"] = "NOS2"

#### RelativeContribution ####

PathwaysToKeep = c('Glycolysis / Gluconeogenesis',
                   'Pentose phosphate pathway',
                   'Pyruvate metabolism',
                   'Nucleotide metabolism',
                   'Arginine and proline metabolism',
                   'Purine metabolism',
                   'Pyrimidine metabolism',
                   'Fatty acid biosynthesis',
                   'Pyrimidine metabolism',
                   'Fatty acid oxidation',
                   'Oxidative phosphorylation',
                   'Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism')

FunRelativeContrib = function(LPSModel, IL4Model, ControlModel, title) {
  
LPSFluxSum = LPSModel  %>%
  dplyr::group_by(Subsystem) %>%
  dplyr::summarize(AbsSum = sum(abs(Flux), na.rm = T))

IL4FluxSum = IL4Model %>%
  dplyr::group_by(Subsystem) %>%
  dplyr::summarize(AbsSum = sum(abs(Flux), na.rm = T))

CtrlFluxSum = ControlModel %>%
  dplyr::group_by(Subsystem) %>%
  dplyr::summarize(AbsSum = sum(abs(Flux), na.rm = T))

CommonSubsystems = intersect(intersect(LPSFluxSum$Subsystem, IL4FluxSum$Subsystem),
                             CtrlFluxSum$Subsystem)

LPSFluxSum = LPSFluxSum  %>%
  dplyr::filter(Subsystem %in% CommonSubsystems) %>%
  dplyr::filter(!Subsystem == "NA")

IL4FluxSum = IL4FluxSum %>%
  dplyr::filter(Subsystem %in% CommonSubsystems) %>%
  dplyr::filter(!Subsystem == "NA")

CtrlFluxSum = CtrlFluxSum %>%
  dplyr::filter(Subsystem %in% CommonSubsystems) %>%
  dplyr::filter(!Subsystem == "NA")

TotalFlux = data.frame(Subsystem = LPSFluxSum$Subsystem,
                       LPSFlux = LPSFluxSum$AbsSum,
                       IL4Flux = IL4FluxSum$AbsSum,
                       CtrlFlux = CtrlFluxSum$AbsSum)

TotalFlux = TotalFlux %>%
  dplyr::filter(Subsystem %in% PathwaysToKeep)

# TotalFlux$Subsystem = str_replace_all(TotalFlux$Subsystem,
#                                          "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism",
#                                          "TCA cycle")

TotalFlux = TotalFlux[!grepl("Vitamin", TotalFlux$Subsystem),] #for Poster plot
TotalFlux = TotalFlux[!grepl("Glycos", TotalFlux$Subsystem),] #for Poster plot

TotalFlux$SumAllModels = apply(TotalFlux[c(2,3,4)], MARGIN = 1, sum)

TotalFlux = TotalFlux[!rowSums(TotalFlux[c(2,3,4)]) <= 1e-2,] #if the sum across different GEMs is < 1e-2
TotalFluxRelContribution = TotalFlux %>%
  mutate(LPSRelContribution = (LPSFlux * 1) / SumAllModels) %>%
  mutate(IL4RelContribution = (IL4Flux * 1) / SumAllModels) %>%
  mutate(CtrlRelContribution = (CtrlFlux * 1) / SumAllModels) %>%
  dplyr::select(Subsystem, LPSRelContribution, IL4RelContribution, CtrlRelContribution)

TotalFluxRelContribution = na.omit(TotalFluxRelContribution)

TotalFluxRelContribution = TotalFluxRelContribution %>%
  mutate(Order = case_when(
    LPSRelContribution > IL4RelContribution & LPSRelContribution > CtrlRelContribution ~ "1",
    IL4RelContribution > LPSRelContribution & IL4RelContribution > CtrlRelContribution ~ "2",
    CtrlRelContribution > LPSRelContribution & CtrlRelContribution > IL4RelContribution ~ "3"
  ))

TotalFluxRelContribution = na.omit(TotalFluxRelContribution)

meltedDf = melt(TotalFluxRelContribution)

meltedDf = meltedDf %>%
  arrange(Order)

meltedDf$Order = as.numeric(meltedDf$Order)

relContribPlot = ggplot(meltedDf, aes(x=reorder(Subsystem, Order), y=value, fill=variable))+
  geom_bar(position='stack', stat="identity", color="black", linewidth=0.7) +
  coord_flip() +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) + 
  scale_fill_manual(values=c("LPSRelContribution" = "#56B4E9", # explicitly map color to the factor
                             "IL4RelContribution" = "#E69F00",
                             "CtrlRelContribution" = "#984EA3"),
                    labels = c('LPS', 'IL4', 'Control')) + # explicitly change legend text
  theme_minimal() +
  theme(axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 10),
        legend.title = element_text(face = "bold", size = 10),
        legend.text = element_text(face = "bold", size = 10),
        title = element_text(face = "bold")) +
  labs(y = "Relative Flux Contribution (pFBA)", x = NULL) +
  guides(fill=guide_legend(title="Models:"))

FluxDistr = rbind(LPSModel, IL4Model, ControlModel)

FluxDistr$Model = rep(c("LPS", "IL4", "Control"), times = c(nrow(LPSModel),
                                                            nrow(IL4Model),
                                                            nrow(ControlModel)))
FluxSumarize = FluxDistr %>%
  group_by(Subsystem)
FluxSumarize$Order = TotalFluxRelContribution$Order[match(FluxSumarize$Subsystem,
                                                          TotalFluxRelContribution$Subsystem)]

FluxSumarize = FluxSumarize %>%
  dplyr::filter(!is.na(Order)) %>% #remove NAs
  dplyr::filter(!Flux == 0) %>%
  dplyr::filter(Subsystem %in% PathwaysToKeep)

FluxSumarize$Order = as.numeric(FluxSumarize$Order)

boxPlot = ggplot(FluxSumarize, aes(x=Flux, y=reorder(Subsystem, Order), fill=Model)) +
  geom_boxplot() +
  scale_fill_manual(values=c("LPS" = "#56B4E9", # explicitly map color to the factor
                             "IL4" = "#E69F00",
                             "Control" = "#984EA3")) +
  theme_minimal() +
  theme(axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 10),
        legend.title = element_text(face = "bold", size = 10),
        legend.text = element_text(face = "bold", size = 10),
        axis.text.y=element_blank()) +
  labs(x = "Absolute Flux (pFBA)", y = NULL)

fig = ggarrange(relContribPlot, boxPlot,
                ncol = 2, nrow = 1,
                common.legend = T,
                legend = "bottom")

fig = annotate_figure(fig, top = text_grob(title, face = "bold"))

return(fig)

}


#### Curated FVA ####
#load all 3 datasets containing fluxes for models (IL4RXN etc., plus "reactions" file)
options(scipen = 999)
path = '/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/NewFVAResults/'

fvaprep = function(df, rxnlist, AllKnownRxnsFile) {
  # InterestingSubsystems = c("Glycolysis / Gluconeogenesis",
  #                           "Pentose phosphate pathway",
  #                           "Arginine and proline metabolism",
  #                           "Oxidative phosphorylation",
  #                           "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism")
  
  df$Equation = rxnlist$EQUATION[match(df$ReactionID, rxnlist$ID)]
  df$ReactionName = AllKnownRxnsFile$rxnRecon3DID[match(df$ReactionID, AllKnownRxnsFile$rxns)]
  df = df %>%
    #dplyr::filter_if(., is.numeric, any_vars((.) != 0)) %>%
    dplyr::filter(MinFlux != 0 & MaxFlux !=0) %>%
    mutate(FluxDiff = abs(MinFlux - MaxFlux)) %>%
    relocate(FluxDiff, .after = MaxFlux) %>%
    relocate(ReactionName, .after = ReactionID) %>%
    #dplyr::filter(Compartment %in% InterestingSubsystems) %>%
    arrange(FluxDiff)
  
  
}

#IL4
IL4 = read.csv(paste0(path, 'FVAIL4.csv'))
IL4 = fvaprep(IL4, IL4RXN, reactions)
# LPS
LPS = read.csv(paste0(path, 'FVALPS.csv'))
LPS = fvaprep(LPS, LPSRXN, reactions)
# Control
Control = read.csv(paste0(path, 'FVACONTROL.csv'))
Control = fvaprep(Control, ControlRXN, reactions)
# LPS Cyp27a1 Knockout 
Cyp27a1_KO_FVA_LPS = read.csv(paste0(path, 'FVA_KO_LPS.csv'))
# LPS Gapdh Knockout
Gapdh_KO_FVA_LPS = read.csv(paste0(path, 'FVA_Gapdh_KO_LPS.csv'))

# another idea: one plot per subsystem - 
# in each plot bars are flux values, while error bars are FVA min and max.
# in each plot one bar per model

fvabarplotprep = function(fba, fva) {
  
  df = fba %>%
    dplyr::filter(ReactionID %in% fva$ReactionID)
  
  df = df %>%
    mutate(FVAMin = fva$MinFlux[match(df$ReactionID, fva$ReactionID)]) %>%
    mutate(FVAMax = fva$MaxFlux[match(df$ReactionID, fva$ReactionID)]) %>%
    mutate(FluxDiff = fva$FluxDiff[match(df$ReactionID, fva$ReactionID)]) %>%
    relocate(FVAMin, .after = Flux) %>%
    relocate(FVAMax, .after = FVAMin) %>%
    relocate(FluxDiff, .after = FVAMax) %>%
    dplyr::filter(FluxDiff < 10) # get rid of reactions that have min and max FLux -1000 and 1000, respectively
  
#if(fba == TRUE) {print("this is IL4")}
    #for (i in 23:26) {
     # df[i, 7] = "Arginine and proline metabolism"
     # }
  
  return(df)
  
}


IL4df = fvabarplotprep(IL4GapFilled, IL4)
LPSdf = fvabarplotprep(LPSGapFilled, LPS)
Ctrldf = fvabarplotprep(CtrlGapFilled, Control)


for (i in 23:26) {
 IL4df[i, 7] = "Arginine and proline metabolism"
 }
FVACombined = rbind(IL4df, LPSdf, Ctrldf)
FVACombined$Model = rep(c("IL4", "LPS", "Control"), times = c(dim(IL4df)[1], 
                                                              dim(LPSdf)[1],
                                                              dim(Ctrldf)[1]))


FVACombined$ReactionName = str_replace_all(FVACombined$ReactionName, 
                                        "r0145",
                                        "NOS2")

FVACombined = FVACombined %>%
  mutate(Order = case_when(
    Subsystem == "Glycolysis / Gluconeogenesis" ~ "1",
    Subsystem == "Pentose phosphate pathway" ~ "2",
    Subsystem == "Arginine and proline metabolism" ~ "3",
    Subsystem == "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism" ~ "4",
    Subsystem == "Oxidative phosphorylation" ~ "5")) %>%
  mutate(Order = as.numeric(Order))

FVACombined$Subsystem = str_replace_all(FVACombined$Subsystem, 
                "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism",
                "TCA")
FVACombined$Subsystem = str_replace_all(FVACombined$Subsystem, 
                                        "Glycolysis / Gluconeogenesis",
                                        "Glyco")
FVACombined$Subsystem = str_replace_all(FVACombined$Subsystem, 
                                        "Pentose phosphate pathway",
                                        "PPP")
FVACombined$Subsystem = str_replace_all(FVACombined$Subsystem, 
                                        "Arginine and proline metabolism",
                                        "Arginine/Proline")
FVACombined$Subsystem = str_replace_all(FVACombined$Subsystem, 
                                        "Oxidative phosphorylation",
                                        "OxPhos")
ggplot(FVACombined, aes(x = reorder(ReactionName, Order), y = Flux,
                        fill=Model)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  scale_fill_manual(values=c("LPS" = "#56B4E9", # explicitly map color to the factor
                             "IL4" = "#E69F00",
                             "Control" = "#984EA3")) +
  geom_errorbar(aes(ymin=FVAMin, ymax=FVAMax), width=.2,
                position=position_dodge(.9)) +
  facet_grid(rows = vars(Subsystem),
             scales = "free_y",
             space = "free_y",
             switch = "y") +
  coord_flip() +
  theme(axis.text = element_text(face = "bold", size = 10),
        axis.title = element_text(face = "bold", size = 10),
        legend.title = element_text(face = "bold", size = 14),
        legend.text = element_text(face = "bold", size = 14),
        strip.placement = "outside",                      # Place facet labels outside x axis labels.
        strip.background = element_rect(fill = "white"),
        strip.text.y = element_text(
          size = 9, color = "black", face = "bold.italic")) +  # Make facet label background white.
  labs(x = NULL, y = "Flux")

#### knock-out Fluxes ####
setwd('/Users/rokosango/PhD/MetabModelling/MATLAB_scripts_workspaces/Immunometabolism_models/tINIT_models/GeneKnockoutFluxResults/')

#LPS knockout
LPSGeneDelFluxSolution = read.xlsx('LPSGeneDelFluxSolution.xlsx',
                                   sheetIndex = 1)
IL4GeneDelFluxSolution = read.xlsx('IL4GeneDelFluxSolution.xlsx',
                                   sheetIndex = 1)
CtrlGeneDelFluxSolution = read.xlsx('CtrlGeneDelFluxSolution.xlsx',
                                   sheetIndex = 1)

#for each knockout flux, make a flux table with reaction information etc.

GeneDelFlux = function(df, gene) {
  rownames(df) = df$Row
  
  df$Row = NULL
  
  df = df %>%
    dplyr::select(all_of(gene))
  
  names(df)[1] = "Flux"
  df = df %>%
    mutate(ReactionID = rownames(.))
  
  df$ReactionName = reactions$rxnRecon3DID[match(df$Reaction, reactions$rxns)]
  df$Flux = as.numeric(df$Flux)
  df$Subsystem = LPSRXN$SUBSYSTEM[match(df$ReactionID, LPSRXN$ID)]
  df$Subsystem = as.factor(df$Subsystem)
  df$Equation = LPSRXN$EQUATION[match(df$ReactionID, LPSRXN$ID)]
  
  return(df)
  
}

#make a list for each model and store each respect Knockout and Flux Distribution

#-----------#
LPS_Knockout_List <- list()

for (i in names(LPSGeneDelFluxSolution)[2:length(names(LPSGeneDelFluxSolution))]) {
  
  name =  paste("LPS_KO", i, sep = "_")
  assign(name, 
         LPSGeneDelFluxSolution[i])
  
  LPS_Knockout_List[[i]] = GeneDelFlux(LPSGeneDelFluxSolution, i)
}

LPS_Knockout_List[["WT"]] = LPSGapFilled

#-----------#

IL4_Knockout_List <- list()

for (i in names(IL4GeneDelFluxSolution)[2:length(names(IL4GeneDelFluxSolution))]) {
  
  name =  paste("IL4_KO", i, sep = "_")
  assign(name, 
         IL4GeneDelFluxSolution[i])
  
  IL4_Knockout_List[[i]] = GeneDelFlux(IL4GeneDelFluxSolution, i)
}

IL4_Knockout_List[["WT"]] = IL4GapFilled

#----------#

Ctrl_Knockout_List <- list()

for (i in names(CtrlGeneDelFluxSolution)[2:length(names(CtrlGeneDelFluxSolution))]) {
  
  name =  paste("Ctrl_KO", i, sep = "_")
  assign(name, 
         CtrlGeneDelFluxSolution[i])
  
  Ctrl_Knockout_List[[i]] = GeneDelFlux(CtrlGeneDelFluxSolution, i)
}

Ctrl_Knockout_List[["WT"]] = CtrlGapFilled

for (i in names(LPS_Knockout_List)) {
  print(FunRelativeContrib(LPS_Knockout_List[[i]], IL4_Knockout_List[[i]], 
                     Ctrl_Knockout_List[[i]], paste(i, "knockout", sep = "_")))
  
}

FunRelativeContrib(LPS_Knockout_List[["Cyp27a1"]], IL4_Knockout_List[["Cyp27a1"]], 
                   Ctrl_Knockout_List[["Cyp27a1"]], "Cyp27a1 knockout")

FunRelativeContrib(LPS_Knockout_List[["Phgdh"]], IL4_Knockout_List[["Phgdh"]], 
                   Ctrl_Knockout_List[["Phgdh"]], "Phgdh knockout")

FunRelativeContrib(LPS_Knockout_List[["Arg1"]], IL4_Knockout_List[["Arg1"]], 
                   Ctrl_Knockout_List[["Arg1"]], "Arg1 knockout")

FunRelativeContrib(LPS_Knockout_List[["Alox15"]], IL4_Knockout_List[["Alox15"]], 
                   Ctrl_Knockout_List[["Alox15"]], "Alox15 knockout")

FunRelativeContrib(LPS_Knockout_List[["Setdb2"]], IL4_Knockout_List[["Setdb2"]], 
                   Ctrl_Knockout_List[["Setdb2"]], "Setdb2 knockout")

FunRelativeContrib(LPS_Knockout_List[["Sphk1"]], IL4_Knockout_List[["Sphk1"]], 
                   Ctrl_Knockout_List[["Sphk1"]], "Sphk1 knockout")

FunRelativeContrib(LPS_Knockout_List[["Sphk2"]], IL4_Knockout_List[["Sphk2"]], 
                   Ctrl_Knockout_List[["Sphk2"]], "Sphk2 knockout")


#check contributions within each model, i.e. LPS WT against all knockouts

FunRelativeContribWithAllKnockouts = function(ListModelKnockouts, tissue) {
  
  CommonSubsystems = Reduce(intersect, list(ListModelKnockouts[["WT"]]$Subsystem,
                                            ListModelKnockouts[["Cyp27a1"]]$Subsystem))
  
  
  for (i in names(ListModelKnockouts)) {
    
    ListModelKnockouts[[i]] = ListModelKnockouts[[i]] %>%
      dplyr::group_by(Subsystem) %>%
      dplyr::summarize(AbsSum = sum(abs(Flux), na.rm = T))
    
    ListModelKnockouts[[i]] = ListModelKnockouts[[i]] %>%
      dplyr::filter(!Subsystem == "NA") %>% 
      dplyr::filter(Subsystem %in% CommonSubsystems)
  }
  
  options(scipen = 999)
  
  TotalFlux = data.frame(Subsystem = ListModelKnockouts[["WT"]]$Subsystem,
                         WT = ListModelKnockouts[["WT"]][["AbsSum"]],
                         Cyp27a1 = ListModelKnockouts[["Cyp27a1"]][["AbsSum"]])
  
  
  TotalFlux$SumAllModels = rowSums(TotalFlux[2:ncol(TotalFlux)])
  TotalFlux$SD = apply(TotalFlux[3:ncol(TotalFlux)-1], 1, sd)
  TotalFlux = TotalFlux %>% arrange(desc(SD))
  
  TotalFlux = TotalFlux[!rowSums(TotalFlux[c(2:ncol(TotalFlux))]) <= 1e-2,] #if the sum across different GEMs is < 1e-2
  TotalFluxRelContribution = TotalFlux %>%
    mutate(WT_RelContribution = (WT * 1) / SumAllModels) %>%
    mutate(Cyp27a1_RelContribution = (Cyp27a1 * 1) / SumAllModels) %>%
    dplyr::select(Subsystem, WT_RelContribution, Cyp27a1_RelContribution)
  
  TotalFluxRelContribution = na.omit(TotalFluxRelContribution)
  
  meltedDf = melt(TotalFluxRelContribution)
  
  meltedDf$Subsystem = as.factor(meltedDf$Subsystem)
  
  PathwaysToRemove = c('Cysteine and methionine metabolism',
                       'Cholesterol metabolism',
                       'Carnitine shuttle (mitochondrial)',
                       'Carnitine shuttle (endoplasmic reticular)',
                       'Carnitine shuttle (cytosolic)',
                       'Butanoate metabolism',
                       'Biopterin metabolism',
                       'Bile acid recycling',
                       "Pool reactions",
                       "Transport reactions",
                       "Miscellaneous",
                       "Exchange/demand reactions",
                       "Inositol phosphate metabolism",
                       "Peptide metabolism",
                       "Prostaglandin biosynthesis",
                       "Valine, leucine, and isoleucine metabolism",
                       "Sulfur metabolism",
                       "Steroid metabolism",
                       "Starch and sucrose metabolism",
                       "Sphingolipid metabolism",
                       "ROS detoxification",
                       "Retinol metabolism",
                       "Protein modification",
                       "Porphyrin metabolism",
                       "Heparan sulfate degradation",
                       "Glycerolipid metabolism",
                       "Glycerophospholipid metabolism",
                       "Glutathione metabolism",
                       "Galactose metabolism",
                       "Aminoacyl-tRNA biosynthesis",
                       "Alanine, aspartate and glutamate metabolism",
                       "Amino sugar and nucleotide sugar metabolism",
                       "Artificial reactions",
                       "Isolated",
                       "Glycine, serine and threonine metabolism",
                       "Leukotriene metabolism",
                       "Nicotinate and nicotinamide metabolism",
                       "Pentose and glucuronate interconversions",
                       "Omega-6 fatty acid metabolism",
                       "N-glycan metabolism",
                       "Lipoic acid metabolism",
                       "Acylglycerides metabolism",
                       "Drug metabolism")
                      
  
  meltedDf = meltedDf %>%
    dplyr::filter(!Subsystem %in% PathwaysToRemove)
  
  meltedDf = meltedDf[!grepl("Vitamin", meltedDf$Subsystem),] #for Poster plot
  meltedDf = meltedDf[!grepl("Fatty", meltedDf$Subsystem),] #for Poster plot
  meltedDf = meltedDf[!grepl("Glycos", meltedDf$Subsystem),] #for Poster plot
  
  
  meltedDf$Subsystem = str_replace_all(meltedDf$Subsystem, 
                                       "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism",
                                       "TCA cycle")
  
  g = ggplot(meltedDf, aes(x=Subsystem, y=value, fill=variable))+
    geom_bar(position='stack', stat="identity", color="black", linewidth=0.5) +
    coord_flip() +
    #scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
    #scale_y_continuous(breaks=c(0, 0.25, 0.5, 0.75, 1.1)) +
    scale_fill_manual(values=c("WT_RelContribution" = "#1B9E77", # explicitly map color to the factor
                               "Cyp27a1_RelContribution" = "#D95F02"
    ),
    labels = c('WT', 'Cyp27a1 KO')) + # explicitly change legend text
    theme_minimal() +
    theme(axis.text.x = element_text(face = "bold", size = 9),
          axis.text.y = element_text(face = "bold", size = 11),
          axis.title = element_text(face = "bold", size = 10),
          legend.title = element_text(face = "bold", size = 10),
          legend.text = element_text(face = "bold", size = 10),
          legend.position = "right",
          title = element_text(face = "bold")) +
    labs(y = "Relative Flux Contribution (pFBA)", x = NULL, title = NULL) +
    guides(fill=guide_legend(title="Models:"))
  
  res = list(TotalFlux, g)
  names(res) = c("TableSummedFluxes", "RelContribPlot")
  
  return(res)
  
}

LPS_KO_Results = FunRelativeContribWithAllKnockouts(LPS_Knockout_List, 'LPS')

IL4_KO_Results = FunRelativeContribWithAllKnockouts(IL4_Knockout_List, 'IL4')

Ctrl_KO_Results = FunRelativeContribWithAllKnockouts(Ctrl_Knockout_List, 'Control')

NewConstLPS_KO_Results= FunRelativeContribWithAllKnockouts('LPS')

# df from LPS WT and Gapdh 

common_rxns = intersect(LPS_Knockout_List[["WT"]]$ReactionID, LPS_Knockout_List[["Gapdh"]]$ReactionID)

WT_Glyco = subset(LPS_Knockout_List[["WT"]], Subsystem == "Glycolysis / Gluconeogenesis" & ReactionID %in% common_rxns)

Gapdh_KO_Glyco = subset(LPS_Knockout_List[["Gapdh"]], Subsystem == "Glycolysis / Gluconeogenesis" & ReactionID %in% common_rxns)

Gapdh_KO_WT_df = cbind(WT_Glyco[1:4], Gapdh_KO_Glyco[1])

names(Gapdh_KO_WT_df)[c(2, 5)] = c("Flux_WT","Flux_Gapdh_KO")

#ReactionNames = c("HEX1", "PGI", "PFK", "FBA", "TPI", "GAPD", "PGK", "PGM", "ENO", "PYK")

Gapdh_KO_WT_df = Gapdh_KO_WT_df %>% 
  select(order(colnames(Gapdh_KO_WT_df))) %>%
  dplyr::filter(!(Flux_WT == 0 & Flux_Gapdh_KO == 0)) 
  #dplyr::filter(ReactionName %in% ReactionNames)

Gapdh_KO_WT_df = melt(Gapdh_KO_WT_df)

ggplot(data=Gapdh_KO_WT_df, aes(x=ReactionName, y=value, fill=variable)) +
  geom_bar(stat="identity", color="black", position=position_dodge())+
  theme_minimal() +
  labs(y = "Flux", x = NULL, title = "Glycolysis pFBA") + 
  coord_flip() + 
  theme(axis.text = element_text(face = "bold", size = 11),
        axis.title = element_text(face = "bold", size = 10),
        legend.title = element_text(face = "bold", size = 10),
        legend.text = element_text(face = "bold", size = 10),
        legend.position = "top",
        title = element_text(face = "bold")) +
  scale_fill_manual(values=c('#A16864','#1B9E77')) +
  guides(fill=guide_legend(title="Models:"))

#### LPS Knockout Fluxes: ####
# choose: 
# Bile acid biosynthesis, 
# Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism
# Pyrimidine metabolism
# Heme synthesis

InterestingSubs = c("Bile acid biosynthesis", 
                    "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism",
                    "Pyrimidine metabolism", "Heme synthesis")

ProcessPlotFun = function(df1, df2, InterestingSubs, gene) {
  
   df1 = LPSGapFilled %>%
    dplyr::filter(Subsystem %in% InterestingSubs) %>%
    dplyr::group_by(Subsystem) %>%
    dplyr::summarize(AbsMean = mean(abs(Flux), na.rm = T),
              SDMean = sd(Flux, na.rm = T))
   
  df2 = LPS_Knockout_List[[gene]] %>%
    dplyr::filter(Subsystem %in% InterestingSubs) %>%
    dplyr::group_by(Subsystem) %>%
    dplyr::summarize(AbsMean = mean(abs(Flux), na.rm = T),
              SDMean = sd(Flux, na.rm = T))
  
  combined = rbind(df1, df2)
  
  combined$Subsystem = str_replace_all(combined$Subsystem, 
                                       "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism",
                                       "TCA cycle")
  
  combined$Model = rep(c("WT", "Cyp27a1"), each = 4)
  combined$Model = as.factor(combined$Model)
  combined$Subsystem = str_wrap(combined$Subsystem, width = 10)
  
  ggplot(combined, aes(x = Subsystem, y = AbsMean,
                 fill=Model)) +
    geom_bar(stat = "identity", color = "black", 
             position = position_dodge()) +
    scale_fill_manual(values=c("WT" = "#1B9E77", #D95F02
                               'Cyp27a1' = "#D95F02"), # 1B9E77
                      labels = c('Cyp27a1_KO', 'WT')) +
    geom_errorbar(aes(ymin=(AbsMean - SDMean), 
                      ymax=(AbsMean + SDMean)), 
                      width=.2,
                      position=position_dodge(.9)) +
    #coord_flip() +
    labs(x = NULL, y = "Flux") +
    theme_bw() +
    theme(axis.text = element_text(face = "bold", size = 15),
          axis.title = element_text(face = "bold", size = 15),
          legend.title = element_text(face = "bold", size = 10),
          legend.text = element_text(face = "bold", size = 10),
          legend.position = c(0.15, 0.9),
          legend.background = element_rect(fill = "white", color = "black"))
    
  
}

ProcessPlotFun(LPSGapFilled, LPS_Knockout_List[["Cyp27a1"]],
               InterestingSubs, 'Cyp27a1')



#### focus on specific subsystems and reactions within subsystems of interest:


SpecFluxesFun = function(WT_df, KO_df, FVA_WT,FVA_KO_df,
                         WhichGene, ColourKO, Wildtype, 
                         ColourWT, WhichSubsystem, title) {
      #needs FVA, Knockout and FBA dataframes.
      df = LPSGapFilled %>%
        dplyr::filter(Subsystem %in% WhichSubsystem) #WhichSubsystem
        
      
      if (WhichGene != "Gapdh") {
        df = df %>%
          dplyr::filter(Flux != 0)

      }
      
      df = df %>%
        dplyr::mutate(FVAMin = FVA_WT$MinFlux[match(df$ReactionID, FVA_WT$ReactionID)]) %>% #LPS = WT FVA
        dplyr::mutate(FVAMax = FVA_WT$MaxFlux[match(df$ReactionID, FVA_WT$ReactionID)]) %>% #LPS = WT FVA
        dplyr::mutate(FVAHalfPoint = (FVAMin + FVAMax) / 2) %>%
        relocate(FVAMin, .after = Flux) %>%
        relocate(FVAMax, .after = FVAMin)


      df2 = LPS_Knockout_List[[WhichGene]] %>% #WhichGene
        dplyr::filter(Subsystem %in% WhichSubsystem) %>%
        dplyr::filter(ReactionID %in% df$ReactionID)
      
      df2 = df2 %>%
        dplyr::mutate(FVAMin = FVA_KO_df$MinFlux[match(df2$ReactionID, FVA_KO_df$ReactionID)]) %>% #KO_LPS = FVA_KO_df
        dplyr::mutate(FVAMax = FVA_KO_df$MaxFlux[match(df2$ReactionID, FVA_KO_df$ReactionID)]) %>%
        dplyr::mutate(FVAHalfPoint = (FVAMin + FVAMax) / 2) %>%
        relocate(FVAMin, .after = Flux) %>%
        relocate(FVAMax, .after = FVAMin)
      
      combined = rbind(df, df2)
      combined$Model = rep(c("WT", WhichGene), each = dim(df)[1])
      #combined$ReactionID = factor(combined$ReactionID, levels = unique(rev(sort(combined$ReactionID))))
      #uncomment above line for displaying plots in alphanumerical order.
      #however, uncommenting it  makes the density plot `arrangedplots` perform weirdly!
      
      #this line needed so that colours are properly mapped
      #to respective name. With this, the entire function can be generalized to other KO genes of interest
      cols = vctrs::vec_c(!!WhichGene := ColourKO,
                           !!Wildtype := ColourWT) 
      
      if (WhichGene == "Gapdh") {

        GlycolysisReactionNames = c("HK", "PGI", "PFK", "ALDO", "TPI", "GAPDH", "PGK", "PGM", "ENO", "PK")
        GlycolysisReactionNames = as.factor(GlycolysisReactionNames)

        combined$ReactionName = str_replace_all(combined$ReactionName,"r0191", "PFK")
        combined$ReactionName = str_replace_all(combined$ReactionName,"FBA", "ALDO")
        combined$ReactionName = str_replace_all(combined$ReactionName,"PYK", "PK")
        combined$ReactionName = str_replace_all(combined$ReactionName,"HEX1", "HK")
        combined$ReactionName = str_replace_all(combined$ReactionName,"GAPD", "GAPDH")
        
        combined = combined %>%
          dplyr::filter(ReactionName %in% GlycolysisReactionNames)
        combined$ReactionID = factor(combined$ReactionID, levels = GlycolysisReactionNames)
        
        #library(forcats)
        
        combined = combined %>%
          mutate(Order = case_when(
          ReactionName == "HK" ~ 1,
          ReactionName == "PGI" ~ 2,
          ReactionName == "PFK" ~ 3,
          ReactionName == "ALDO" ~ 4,
          ReactionName == "TPI" ~ 5,
          ReactionName == "GAPDH" ~ 6,
          ReactionName == "PGK" ~ 7,
          ReactionName == "PGM" ~ 8,
          ReactionName == "ENO" ~ 9,
          ReactionName == "PK" ~ 10)) %>%
          mutate(ReactionName = fct_reorder(ReactionName, desc(Order)))
          
      }
      
      fba = ggplot(combined, aes(x = #ifelse(WhichSubsystem == "Bile acid biosynthesis",
                                            #ReactionID, 
                                 ReactionID, y = Flux,
                           fill=Model)) +
        geom_bar(stat = "identity", color = "black", 
                 position = position_dodge()) +
        scale_fill_manual(values=cols,
                          labels = c(paste0(WhichGene, '_KO'), 'WT')) +
        coord_flip() +
        labs(x = NULL, y = "Flux", title = 'pFBA') +
        theme_bw() +
        theme(axis.text = element_text(face = "bold", size = 11),
              axis.title = element_text(face = "bold", size = 10),
              legend.title = element_text(face = "bold", size = 10),
              legend.text = element_text(face = "bold", size = 10),
              plot.title = element_text(face = "bold"))
      
      fva = ggplot(combined, aes(x = ReactionName, y = FVAHalfPoint, 
                                 color=Model, group=Model)) +
        geom_errorbar(aes(ymin=FVAMin, ymax=FVAMax), width=1,
                      position=position_dodge(0.5)) +
        scale_color_manual(values=cols,
                           labels = c(paste0(WhichGene, '_KO'), 'WT')) +
        labs(x = NULL, y = "Flux", title = 'FVA') +
        coord_flip() +
        theme_bw() +
        theme(axis.text = element_text(face = "bold", size = 11),
              axis.title = element_text(face = "bold", size = 10),
              axis.text.y = element_blank(),
              legend.title = element_text(face = "bold", size = 10),
              legend.text = element_text(face = "bold", size = 10),
              plot.title = element_text(face = "bold"))
      
      fig = ggarrange(fba, fva,
                      ncol = 2, nrow = 1,
                      common.legend = T,
                      legend = "bottom")
      
      fig = annotate_figure(fig, top = text_grob(title, face = "bold"))
      
      return_list = list(fig, combined)
      names(return_list) = c("CombinedFigure", "CombinedDataset")
      
      return(return_list)
      
}

BileAcid = SpecFluxesFun(LPSGapFilled, LPS_Knockout_List[["Cyp27a1"]], LPS,
                         Cyp27a1_KO_LPS,
                     WhichGene = "Cyp27a1", ColourKO = "#D95F02",
                     Wildtype = "WT", ColourWT = "#1B9E77",
                     "Bile acid biosynthesis", 
                     "Bile acid biosynthesis")

PyrMet = SpecFluxesFun(LPSGapFilled, LPS_Knockout_List[["Cyp27a1"]], LPS,
                       Cyp27a1_KO_LPS,
                       WhichGene = "Cyp27a1", ColourKO = "#D95F02",
                       Wildtype = "WT", ColourWT = "#1B9E77",
                       "Pyrimidine metabolism", 
                       "Pyrimidine metabolism")

HemeSynth = SpecFluxesFun(LPSGapFilled, LPS_Knockout_List[["Cyp27a1"]], LPS,
                          Cyp27a1_KO_LPS,
                          WhichGene = "Cyp27a1", ColourKO = "#D95F02",
                          Wildtype = "WT", ColourWT = "#1B9E77",
                          "Heme synthesis", 
                          "Heme synthesis")

TCAMet = SpecFluxesFun(LPSGapFilled, LPS_Knockout_List[["Cyp27a1"]], LPS, 
                       Cyp27a1_KO_LPS,
                       WhichGene = "Cyp27a1", ColourKO = "#D95F02",
                       Wildtype = "WT", ColourWT = "#1B9E77",
                       "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism", 
                       "Tricarboxylic acid cycle")

Glyco = SpecFluxesFun(LPSGapFilled, LPS_Knockout_List[["Gapdh"]], LPS,
                      Gapdh_KO_LPS,
                      WhichGene = "Gapdh", ColourKO = "#A16864",
                      Wildtype = "WT", ColourWT = "#1B9E77",
                      "Glycolysis / Gluconeogenesis",
                      "Glycolysis")


#r0191 = PFK
#### Random sampling by ACHR ####

LPSSampledModelRxnID = read.table('~/PhD/MetabModelling/MATLAB_scripts_workspaces/SamplingResults/LPSModelSamplingRxns.txt', 
                                  col.names = "Reaction")

IL4SampledModelRxnID = read.table('~/PhD/MetabModelling/MATLAB_scripts_workspaces/SamplingResults/IL4ModelSamplingRxns.txt', 
                                  col.names = "Reaction")

KO_LPSSampledModelRxnID = read.table('~/PhD/MetabModelling/MATLAB_scripts_workspaces/SamplingResults/KO_LPSModelSamplingRxns.txt',
                                  col.names = "Reaction")

#CommonRxns = intersect(IL4SampledModelRxnID$Reaction,
#                       LPSSampledModelRxnID$Reaction)

CommonRxns = intersect(KO_LPSSampledModelRxnID$Reaction,
                       LPSSampledModelRxnID$Reaction)

filter = function(df) {
  df = df %>%
    dplyr::filter(rownames(df) %in% CommonRxns) %>%
    arrange(rownames(.))
  return(df)
}
                       


#LPS

path = '~/PhD/MetabModelling/MATLAB_scripts_workspaces/SamplingResults/LPS/'


# load up the data: reaction IDs & flux matrices
#find reactions that are shared across LPS & IL4
#arrange rows in both conditions (10 frames per model)
# for each output file (10), find mean of each sampled flux
# explore densities of those reactions (side by side densities per model)
#focus on reactions in glycolysis, tca, oxphos, ppp and arginine pathways
# use Kruskal–Wallis test to find significant reactions
LPSdata_files <- list.files(paste0(path))  # Identify file names
LPSdata_files


for(i in 1:length(LPSdata_files)) {                              # Head of for-loop
  assign(paste0("LPSSamplingFile_", i),                                   # Read and store data frames
         read.csv(paste0(path,
                          LPSdata_files[i]),
                   header = F, 
                   col.names = paste0(rep("sample", times = 1000), rep(1:1000)),
                   row.names =  LPSSampledModelRxnID$Reaction))
}


LPS_list = list(LPSSamplingFile_1, LPSSamplingFile_2, LPSSamplingFile_3, LPSSamplingFile_4,
                LPSSamplingFile_5, LPSSamplingFile_6, LPSSamplingFile_7, LPSSamplingFile_8,
                LPSSamplingFile_9, LPSSamplingFile_10)

SampleFileNames = paste0("LPSSamplingFile_10", 1:10)

for (i in 1:length(LPS_list)) {
  
  LPS_list[[i]] = filter(LPS_list[[i]])
  names(LPS_list)[i] = SampleFileNames[i]
  
}

LPSSamplingMeanDf = Reduce(`+`, LPS_list)/length(LPS_list)

#IL4


path = '~/PhD/MetabModelling/MATLAB_scripts_workspaces/SamplingResults/IL4/'

IL4data_files <- list.files(paste0(path))  # Identify file names
IL4data_files

for(i in 1:length(IL4data_files)) {                              # Head of for-loop
  assign(paste0("IL4SamplingFile_", i),                                   # Read and store data frames
         read.csv(paste0(path,
                         IL4data_files[i]),
                  header = F, 
                  col.names = paste0(rep("sample", times = 1000), rep(1:1000)),
                  row.names = IL4SampledModelRxnID$Reaction))
}


IL4_list = list(IL4SamplingFile_1, IL4SamplingFile_2, IL4SamplingFile_3, IL4SamplingFile_4,
                IL4SamplingFile_5, IL4SamplingFile_6, IL4SamplingFile_7, IL4SamplingFile_8,
                IL4SamplingFile_9, IL4SamplingFile_10)

SampleFileNames = paste0("IL4SamplingFile_", 1:10)

for (i in 1:length(IL4_list)) {
  
  IL4_list[[i]] = filter(IL4_list[[i]])
  names(IL4_list)[i] = SampleFileNames[i]
  
}

IL4SamplingMeanDf = Reduce(`+`, IL4_list)/length(IL4_list)
# LPS Knockout

path = '~/PhD/MetabModelling/MATLAB_scripts_workspaces/SamplingResults/KO_LPS/'

KO_LPSdata_files <- list.files(paste0(path))  # Identify file names
KO_LPSdata_files

for(i in 1:length(KO_LPSdata_files)) {                              # Head of for-loop
  assign(paste0("KO_LPSSamplingFile_", i),                                   # Read and store data frames
         read.csv(paste0(path,
                         KO_LPSdata_files[i]),
                  header = F, 
                  col.names = paste0(rep("sample", times = 1000), rep(1:1000)),
                  row.names = KO_LPSSampledModelRxnID$Reaction))
}

KO_LPS_list = list(KO_LPSSamplingFile_1, KO_LPSSamplingFile_2, KO_LPSSamplingFile_3, KO_LPSSamplingFile_4,
                   KO_LPSSamplingFile_5, KO_LPSSamplingFile_6, KO_LPSSamplingFile_7, KO_LPSSamplingFile_8,
                   KO_LPSSamplingFile_9, KO_LPSSamplingFile_10)

SampleFileNames = paste0("KO_LPSSamplingFile_", 1:10)

for (i in 1:length(KO_LPS_list)) {
  
  KO_LPS_list[[i]] = filter(KO_LPS_list[[i]])
  names(KO_LPS_list)[i] = SampleFileNames[i]
  
}

#do element-wise addition and divide by the number of the list elements. i.e., get the mean of
#each sampled flux for each cell across 10 list elements
KO_LPSSamplingMeanDf = Reduce(`+`, KO_LPS_list)/length(KO_LPS_list)

#concat different sampling models to compare significance
concat_sampling_dfs = function(sampling_mean_df1, 
                               sampling_mean_df2,
                               sampling_df1_names,
                               sampling_df2_names,
                               model,
                               InterestingSubsystems) {
  
  options(scipen = 4)
  
  df = cbind(sampling_mean_df1,
             sampling_mean_df2)
  
  pvals <- apply(df, 1, function(x) {
    wilcox.test(x[1:1000], x[1001:2000])$p.value
  })
  

  adjpvals = p.adjust(pvals, method = "bonferroni")
  adjpvals = adjpvals[adjpvals < 1e-5]
  
  df = df[names(adjpvals),]
  names(df) = c(paste0(sampling_df1_names, 1:1000), paste0(sampling_df2_names, 1:1000))
  df$Subsystem = model$Subsystem[match(rownames(df),
                                              model$ReactionID)]
  df$ReactionName= model$ReactionName[match(rownames(df),
                                                   model$ReactionID)]
  
  df = df %>% 
    relocate(Subsystem, .before = LPS_Sample_1) %>%
    relocate(ReactionName, .after = Subsystem) %>%
    arrange(Subsystem) %>%
    mutate(AdjPvals = adjpvals[match(names(adjpvals),
                                     rownames(df))]) %>%
    relocate(AdjPvals, .after = ReactionName) %>%
    mutate(ReactionID = rownames(.)) %>%
    relocate(ReactionID, .after = AdjPvals) %>%
    dplyr::filter(Subsystem %in% InterestingSubsystems)
  
}

InterestingSubsystems = c("Bile acid biosynthesis",
                          "Heme synthesis",
                          "Pyrimidine metabolism",
                          "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism",
                          "Glycolysis / Gluconeogenesis")


combined_mean_dfs = concat_sampling_dfs(LPSSamplingMeanDf, KO_LPSSamplingMeanDf,
                         "LPS_Sample_", "KO_LPS_Sample_",
                         LPSGapFilled, InterestingSubsystems)

#function for generating density plots from significant
#reactions sampled from 5 different subsystems

densityplotsfun = function(sampling_mean_df1, 
                           sampling_mean_df2,
                           reactionID, Model1Factor,
                           Model2Factor,
                           FBAModel1, FBAModel2,
                           title) {
  
  combined = melt(rbind(sampling_mean_df1[reactionID, ],
                        sampling_mean_df2[reactionID, ]))
  
  combined$Model = rep(c(Model1Factor, Model2Factor))
  
  m = combined$value[seq(1, length(combined$value), 2)] #every step-wise first sampling model value
  n = combined$value[seq(2, length(combined$value), 2)] #every step-wise second sampling model value
  
  Model1Bar = FBAModel1 %>%
    dplyr::filter(ReactionID == reactionID) %>%
    select(Flux)
  
  Model2Bar = FBAModel2 %>%
    dplyr::filter(ReactionID == reactionID) %>%
    select(Flux)
  
  
  ggplot(combined, aes(x=value, fill=Model)) + 
    geom_density(color="black", alpha=0.9) + 
    scale_x_continuous(trans = pseudolog10_trans) +
    #geom_vline(aes(xintercept=mean(m)),
    #           color="#1B9E77", linetype="dashed", linewidth=1) +
    #geom_vline(aes(xintercept=Model1Bar[1, 1]),
    #         color="#1B9E77", linetype="solid", linewidth=1) +
    #geom_vline(aes(xintercept=mean(n)),
    #           color="#D95F02", linetype="dashed", linewidth=1) +
    #geom_vline(aes(xintercept=Model2Bar[1, 1]),
    #           color="#D95F02", linetype="solid", linewidth=1) +
    scale_fill_manual(values=c("WT" = "#1B9E77", # explicitly map color to the factor
                               "Cyp27a1_KO" = "#D95F02")) +
    theme_bw() +
    theme(axis.text = element_text(face = "bold", size = 12),
          axis.title = element_text(face = "bold", size = 16),
          legend.title = element_text(face = "bold", size = 10),
          legend.text = element_text(face = "bold", size = 10)) +
    labs(x = NULL, y = NULL, title = title)
  
}

densityplotsfun(LPSSamplingMeanDf, KO_LPSSamplingMeanDf,
                "MAR04137", "WT", "Cyp27a1_KO", LPSGapFilled,
                LPS_Knockout_List[["Cyp27a1"]], "MAR04137")

#use this densityplotsfun to get sampling results from rxns that are changing
#between conditions in SpecFluxesFun

unique_rxns = factor(unique_rxns, levels = unique(rev(sort(unique_rxns))))

unique_rxns = TCAMet[[2]]$ReactionID


for (i in 1:length(unique_rxns)){
          
           plotlist[[i]] = print(densityplotsfun(LPSSamplingMeanDf,
                                        KO_LPSSamplingMeanDf,
                                        unique_rxns[i], 
                                        'WT', 'Cyp27a1_KO', 
                                        LPSGapFilled, LPS_Knockout_List[["Cyp27a1"]],
                                        unique_rxns[i]))
}


arrangedplots = function(sampling_mean_df1, 
          sampling_mean_df2,
          subsystem_name,
          subsystem_list, #subsystem = "HemeSynth", "TCAMet", "PyrMet" from SpecFluxesFun. No "BileAcid"
          model1Factor,
          model2Factor,
          FBAModel1, 
          FBAModel2,
          nrow) { 
  
          plotlist = list()
  
          #unique_rxns = unique(subsystem_list[[2]]$ReactionID)
          unique_rxns = unique(sort(subsystem_list[[2]]$ReactionID))
          
    for (i in 1:length(unique_rxns)){
    
    plotlist[[i]] = print(densityplotsfun(sampling_mean_df1,
                                          sampling_mean_df2,
                                          unique_rxns[i], 
                                          model1Factor, model2Factor, 
                                          FBAModel1, FBAModel2,
                                          unique_rxns[i]))
  }
  
  fig = ggarrange(plotlist=plotlist,
                  labels = letters[1:length(plotlist)],
                  ncol = 2, nrow = nrow,
                  common.legend = T)
  
  
  fig
  #require(grid)
  anotfig = annotate_figure(fig, 
                            left = textGrob("Density", rot = 90, vjust = 1, gp = gpar(cex = 0.8)),
                            bottom = textGrob("Sampled Flux", gp = gpar(cex = 0.8)),
                            top = textGrob(subsystem_name))
  
  return(anotfig)
  
}


arrangedplots(LPSSamplingMeanDf,KO_LPSSamplingMeanDf,"TCA Cycle",
              TCAMet, "WT", "Cyp27a1_KO", LPSGapFilled,
              LPS_Knockout_List[["Cyp27a1"]], 4)

arrangedplots(LPSSamplingMeanDf,KO_LPSSamplingMeanDf,"Pyrimidine Metabolism",
              PyrMet, "WT", "Cyp27a1_KO", LPSGapFilled,
              LPS_Knockout_List[["Cyp27a1"]], 7)

arrangedplots(LPSSamplingMeanDf,KO_LPSSamplingMeanDf, "Heme synthesis",
              HemeSynth, "LPS", "Cyp27a1_KO", LPSGapFilled,
              LPS_Knockout_List[["Cyp27a1"]], 1)



#from concatenated LPS + IL4 sampling dataset find reactions 
#that are also found in FVA dataset

FVAfiltSamplingDf = df %>%
  dplyr::filter(rownames(.) %in% FVACombined$ReactionID)

#PYK - MAR04358 - pyruvate kinase reaction:
#it is not in FVA dataset as it is only captured in LPS (not in Control or IL4) but with wide flux range {1, 1000}
# hence it is not in the FBA-FVA figure. but still it would be nice to show last step in
# glycolysis where ATP is being made:

FVAfiltSamplingDf['MAR04358', ] = df['MAR04358', ] #add reaction PYK
FVAfiltSamplingDf['MAR04379', ] = df['MAR04379', ] #add reaction PFK
FVAfiltSamplingDf['MAR04368', ] = df['MAR04368', ] #add reaction PGK
FVAfiltSamplingDf['MAR04394', ] = df['MAR04394', ] #add reaction HEX1

FVAfiltSamplingDf = FVAfiltSamplingDf[!FVAfiltSamplingDf$ReactionName %in% "r0173",]  #remove reaction r0173 (peroxisomal lactate dehydrogenase)


df[!(row.names(df) %in% c("1","2")),]

arrangedplots = function(x, subsystem, nrow) {
 
   plotlist = list()
   
   filtered = x %>%
     dplyr::filter(Subsystem == subsystem)
  
  for (i in 1:dim(filtered)[1]) {
    
    plotlist[[i]] = print(densityplotsfun(rownames(filtered)[i], filtered[i, "ReactionName"]))
    
  }
   
   fig = ggarrange(plotlist=plotlist,
                   labels = letters[1:length(plotlist)],
                   ncol = 2, nrow = nrow, common.legend = T)
   
   fig
   #require(grid)
   anotfig = annotate_figure(fig, 
                left = textGrob("Density", rot = 90, vjust = 1, gp = gpar(cex = 0.8)),
                bottom = textGrob("Sampled Flux", gp = gpar(cex = 0.8)),
                 top = textGrob(subsystem))
   
   return(anotfig)
}

FVAfiltSamplingDf %>% 
  group_by(Subsystem) %>%
  summarise(no_rows = length(Subsystem))


#Subsystem                                                        no_rows
#<fct>                                                                  <int>
#1 Arginine and proline metabolism                                        6
#2 Glycolysis / Gluconeogenesis                                           7
#3 Oxidative phosphorylation                                              2
#4 Pentose phosphate pathway                                              8
#5 Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism       2

arrangedplots(FVAfiltSamplingDf, "Arginine and proline metabolism", 3)
arrangedplots(FVAfiltSamplingDf, "Glycolysis / Gluconeogenesis", 5)
arrangedplots(FVAfiltSamplingDf, "Pentose phosphate pathway", 4)
arrangedplots(FVAfiltSamplingDf, 
              "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism", 2)
arrangedplots(FVAfiltSamplingDf, "Oxidative phosphorylation", 2)



#this is just to compare means and variances LPS vs IL4
LPSSamplingMeanDf$MeanLPS = apply(LPSSamplingMeanDf, 1, mean)
IL4SamplingMeanDf$MeanIL4 = apply(IL4SamplingMeanDf, 1, mean)
LPSSamplingMeanDf$VarLPS = apply(LPSSamplingMeanDf, 1, var)
IL4SamplingMeanDf$VarIL4 = apply(LPSSamplingMeanDf, 1, var)

SamplingDfCombined = data.frame(cbind(
                           rownames(LPSSamplingMeanDf),
                           LPSSamplingMeanDf$MeanLPS,
                           IL4SamplingMeanDf$MeanIL4,
                           LPSSamplingMeanDf$VarLPS,
                           IL4SamplingMeanDf$VarIL4))

names(SamplingDfCombined) = c(
  "ReactionID", "MeanLPS", "MeanIL4", "VarLPS", "VarIL4"
)


rownames(SamplingDfCombined) = rownames(LPSSamplingMeanDf)


######### Cyp27a1 macs validation with metabolomics #########

options(ggrepel.max.overlaps = Inf)

path = '/Users/rokosango/PhD/Metabolomics/data'

RP = read_excel(paste0(path, "/AVMM26_results_raw.xlsx"),
                sheet = 2)

HILIC = read_excel(paste0(path, "/AVMM26_results_raw.xlsx"),
                sheet = 3)

AnalyzeFun = function(df, title) {
  
  dfNum = df %>%
    dplyr::select(-Sample, -Phenotype, -Group)
  
  dfNum = dfNum[!grepl("nq", x = dfNum)]

  dfNum = as.matrix(dfNum)
  
  logm = log(dfNum, 10)
  
  logm = scale(logm, center = T, scale = T)
  row.names(logm) = paste(df$Group, df$Sample, sep = "_")
  row.names(dfNum) = paste(df$Group, df$Sample, sep = "_")
  
  pca <- prcomp(logm, center = F, scale = F)
  pca.var <- pca$sdev^2
  pca.var.per <- round(pca.var/sum(pca.var)*100, 1)
  
  barplot(pca.var.per, main="Scree Plot", xlab="Principal Component", ylab="Percent Variation")
  
  pcaresults <- summary(pca)
  
  scree.data <- as.data.frame(pcaresults$importance) # eigenvalues / standard deviations
  score.data <- as.data.frame(pcaresults$x) # coordinates of the samples (i.e., observations)
  loading.data <- as.data.frame(pcaresults$rotation) # loading scores for individual variables
  
  
  score.data <- score.data[, 1:2]
  score.data$Group <- df$Group
  score.data$Phenotype <- df$Phenotype
  
  perc.var = 100 * pcaresults[["importance"]][2, ]
  
  
  pca = ggplot(score.data, aes(x = PC1, y = PC2)) +
    geom_point(aes(shape = Group, colour = Phenotype)) +
    geom_label_repel(label = rownames(score.data)) +
    stat_ellipse(geom = "polygon", alpha = 1/2, aes(fill = Group)) +
    xlab(paste("PC1:", perc.var[1], "%")) +
    ylab(paste("PC2:", perc.var[2], "%")) +
    ggtitle(title) +
    my.theme


  t.logm = as.data.frame(t(logm))

  order = c(1,2,3,4,13,14,15,16,5,6,7,8,17,18,19,20,9,10,11,12,21,22,23,24)

  t.logm = t.logm[, order]

  annot <- data.frame(Group = rep(c("Control-WT", "Control-KO",
                                    "LPS-WT", "LPS-KO", "IL-4-WT", "IL-4-KO"), each = 4))

  annot$Group <- factor(annot$Group, levels = c("Control-WT", "Control-KO",
                                                "LPS-WT", "LPS-KO",
                                                "IL-4-WT", "IL-4-KO"))

  rownames(annot) <- names(t.logm)

  p = pheatmap(t.logm,
           color = rev(colorRampPalette(c("#B2182B", "#FDDBC7", "#2166AC"))(n = 256)),
           border_color = "gray40",
           scale = "row",
           gaps_col = c(8,16),
           angle_col = 45,
           fontsize_row = 13,
           cluster_cols = F,
           cellwidth = 15,
           annotation_col =  annot,
           annotation_names_col = F,
           main = title
  )
  

# ANOVA #

  logm = t(t.logm)

  logdf = as.data.frame(logm) %>%
    dplyr::mutate(Group = annot$Group) %>%
    dplyr::relocate(Group, .before = names(logm)[1])

  metabolites.list = list()
  MetNames = c()

  for(i in 2:ncol(logdf)){ # if it doesn't work - comment out line 218 and 219 then run the for loop, then run it with removing comments - weird!

    column <- names(logdf[i]) # to print each ROI at the top of each ANOVA summary

    avz <- aov(logdf[,i] ~ Group, data = logdf) # Each ANOVA test iterating through each column of my dataframe

    result <- summary(avz) # summarize each ANOVA in a table
    hsd <- TukeyHSD(avz)

    print(column)
    print(result)
    print(hsd)

    metabolites.list[[i]] = hsd
    names(metabolites.list)[i] = column

    # if (any(hsd$Group[, 4] < 0.05)) {
    #   MetNames[i] = column
    # }

    if (any(as.data.frame(metabolites.list[[i]]$Group)["IL-4-KO-IL-4-WT", 4] < 0.05,
            as.data.frame(metabolites.list[[i]]$Group)["LPS-KO-LPS-WT", 4] < 0.05,
            as.data.frame(metabolites.list[[i]]$Group)["Control-KO-Control-WT", 4] < 0.05)) {

      MetNames[i] = column
    }

  }

  MetNames = na.omit(MetNames)

  metabolites.list = metabolites.list[names(metabolites.list) %in% MetNames]
  
  logm = as.data.frame(logm)
  
  BoxPlotsDf = logm[names(logm) %in% names(metabolites.list)]
  
  BoxPlotsList = list()
  
  for (i in 1:ncol(BoxPlotsDf)) {
    
    BoxPlotsDfSingle = matrix(BoxPlotsDf[,i], ncol = 1, nrow = nrow(BoxPlotsDf))
    colnames(BoxPlotsDfSingle)[1] = "ZScore"
    rownames(BoxPlotsDfSingle) = rownames(BoxPlotsDf)
    BoxPlotsDfSingle = as.data.frame(BoxPlotsDfSingle)
    BoxPlotsDfSingle$Group = annot$Group
    
    BoxPlotsList[[i]] = ggplot(BoxPlotsDfSingle, aes(x=Group, y=ZScore, fill=Group)) +
                        geom_boxplot(position=position_dodge(1)) +
                        geom_dotplot(binaxis='y', stackdir='center',
                        position=position_dodge(1), dotsize = 0.8) +
                        labs(x = NULL, y = "ZScore", title = names(BoxPlotsDf)[i]) +
                        my.theme + coord_flip()
    
    names(BoxPlotsList)[i] = names(BoxPlotsDf)[i]
    
  }
  

  DatasetList = list(metabolites.list,
                     MetNames,
                     p,
                     pca,
                     BoxPlotsList)
  
  names(DatasetList) = c("PostHocStats", "PostHocMetNames", "Heatmap", "PCAPlot", "BoxPlotsList")

  return(DatasetList)

  
}


HILICList = AnalyzeFun(HILIC, "HILIC")
RPList = AnalyzeFun(RP, "RP")



#### IL-4 WT vs KO changes ####

    
Rxns2Check = c("MDHm", "SUCD1m", "FUMm", "r0191", "PGI", 
               "PGMT", "PYK", "r0165", "r0122", "r0153", "HMR_4182", "ADSS")


il4dfwt = IL4_Knockout_List[["WT"]] %>%
  dplyr::filter(ReactionName %in% Rxns2Check) %>%
  mutate(Condition = rep("WT"))

il4dfko = IL4_Knockout_List[["Cyp27a1"]] %>%
  dplyr::filter(ReactionName %in% Rxns2Check) %>%
  mutate(Condition = rep("KO"))

il4df = rbind(il4dfwt, il4dfko)
il4df[il4df=="fructose-6-phosphate[c] <=> glucose-6-phosphate[c]"] <- "glucose-6-phosphate[c] <=> fructose-6-phosphate[c]"
il4df$Flux = abs(il4df$Flux)

ggplot(data=il4df, aes(x=ReactionName, y=Flux, fill=Condition)) +
  geom_bar(stat="identity", color="black", position=position_dodge()) +
  theme_minimal() +
  scale_fill_manual(values=c('#7570B3','#1B9E77')) +
  facet_wrap(vars(Subsystem))

subs = unique(il4df$Subsystem)

for (i in 1:length(subs)) {
  
  df = il4df %>%
    dplyr::filter(Subsystem == subs[i])
  
  if (subs[i] == "Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism") {
    df$Subsystem = sub("Tricarboxylic acid cycle and glyoxylate/dicarboxylate metabolism",
                       "TCA cycle", df$Subsystem)
  }
  
  
  print(ggplot(data=df, aes(x=Equation, y=sqrt(Flux), fill=Condition)) +
    geom_bar(stat="identity", color="black", position=position_dodge(), width = 0.5) +
    theme_minimal() +
    coord_flip() +
    scale_fill_manual(values=c('#7570B3','#1B9E77')) +
    theme(axis.text = element_text(colour="black", size=10, face = "bold"),
          axis.title = element_text(colour="black", size=12, face = "bold"),
          legend.title=element_blank(),
          legend.text = element_text(size = 14),
          legend.position="bottom") +
      scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
    labs(x = NULL, y = expression(sqrt(Flux)), title = df$Subsystem[1]))
}
